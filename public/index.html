<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Server Tƒ©nh - Trang Ch·ªß</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üöÄ Web Server Tƒ©nh - ƒêa Lu·ªìng</h1>
            <p class="subtitle">S·ª≠ d·ª•ng ThreadPoolExecutor ƒë·ªÉ x·ª≠ l√Ω nhi·ªÅu client ƒë·ªìng th·ªùi</p>
        </div>
    </header>

    <nav class="navbar">
        <div class="container">
            <ul class="nav-menu">
                <li><a href="./index.html" class="active">Trang Ch·ªß</a></li>
                <li><a href="./about.html">Gi·ªõi Thi·ªáu</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="container">
            <section class="hero">
                <h2>Ch√†o m·ª´ng ƒë·∫øn Web Server c·ªßa t√¥i!</h2>
                <p>ƒê√¢y l√† m·ªôt web server tƒ©nh vi·∫øt b·∫±ng Python v·ªõi h·ªó tr·ª£ x·ª≠ l√Ω ƒëa lu·ªìng (Threading).</p>
            </section>

            <section class="features">
                <h2>T√≠nh NƒÉng Ch√≠nh</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>‚ö° ƒêa Lu·ªìng</h3>
                        <p>S·ª≠ d·ª•ng ThreadPoolExecutor ƒë·ªÉ x·ª≠ l√Ω nhi·ªÅu client ƒë·ªìng th·ªùi m·ªôt c√°ch hi·ªáu qu·∫£</p>
                    </div>
                    <div class="feature-card">
                        <h3>üìÅ Serve Static Files</h3>
                        <p>Ph·ª•c v·ª• c√°c file tƒ©nh nh∆∞ HTML, CSS, JavaScript, h√¨nh ·∫£nh t·ª´ th∆∞ m·ª•c public/</p>
                    </div>
                    <div class="feature-card">
                        <h3>üîí B·∫£o M·∫≠t</h3>
                        <p>NgƒÉn ch·∫∑n path traversal attack v√† c√°c l·ªó h·ªïng b·∫£o m·∫≠t ph·ªï bi·∫øn</p>
                    </div>
                    <div class="feature-card">
                        <h3>üìä Logging</h3>
                        <p>Ghi l·∫°i c√°c requests v√†o file log theo c√°ch thread-safe</p>
                    </div>
                    <div class="feature-card">
                        <h3>üéØ HTTP Support</h3>
                        <p>H·ªó tr·ª£ GET v√† HEAD methods v·ªõi c√°c status codes th√≠ch h·ª£p</p>
                    </div>
                    <div class="feature-card">
                        <h3>üõë Graceful Shutdown</h3>
                        <p>D·ª´ng server m·ªôt c√°ch an to√†n khi nh·∫•n Ctrl+C</p>
                    </div>
                </div>
            </section>

            <section class="info">
                <h2>Th√¥ng Tin Server</h2>
                <div class="info-box">
                    <table class="info-table">
                        <tr>
                            <td><strong>ƒê·ªãa ch·ªâ Server:</strong></td>
                            <td>127.0.0.1:8000</td>
                        </tr>
                        <tr>
                            <td><strong>Max Threads:</strong></td>
                            <td>10</td>
                        </tr>
                        <tr>
                            <td><strong>Public Directory:</strong></td>
                            <td>public/</td>
                        </tr>
                        <tr>
                            <td><strong>Log File:</strong></td>
                            <td>logs/server.log</td>
                        </tr>
                        <tr>
                            <td><strong>HTTP Methods:</strong></td>
                            <td>GET, HEAD</td>
                        </tr>
                        <tr>
                            <td><strong>MIME Type Detection:</strong></td>
                            <td>T·ª± ƒë·ªông d·ª±a tr√™n extension</td>
                        </tr>
                    </table>
                </div>
            </section>

            <section class="quick-start">
                <h2>H∆∞·ªõng D·∫´n Nhanh</h2>
                <div class="code-block">
                    <p><strong>1. Ch·∫°y Server:</strong></p>
                    <pre><code>python server.py</code></pre>
                    
                    <p><strong>2. Test v·ªõi Client:</strong></p>
                    <pre><code>python client_test.py</code></pre>
                    
                    <p><strong>3. Truy c·∫≠p t·ª´ Browser:</strong></p>
                    <pre><code>http://localhost:5000/</code></pre>
                    <pre><code>http://localhost:5000/client.html/</code></pre>
                </div>
            </section>

            <section class="tech-stack">
                <h2>C√¥ng Ngh·ªá S·ª≠ D·ª•ng</h2>
                <ul class="tech-list">
                    <li>Python 3.x</li>
                    <li>Socket API (Low-level networking)</li>
                    <li>ThreadPoolExecutor (concurrent.futures)</li>
                    <li>Logging module (Thread-safe)</li>
                    <li>HTML5 & CSS3</li>
                </ul>
            </section>

            <section class="cta">
                <h2>T√¨m Hi·ªÉu Th√™m</h2>
                <p>Mu·ªën hi·ªÉu r√µ h∆°n v·ªÅ c√°ch ho·∫°t ƒë·ªông? H√£y xem trang <a href="/about.html">Gi·ªõi Thi·ªáu</a></p>
            </section>

            <section class="server-logs">
                <h2>üìã Live Server Logs</h2>
                <div class="logs-container">
                    <div id="logs-placeholder" class="placeholder">
                        <p>ƒêang ch·ªù d·ªØ li·ªáu t·ª´ server...</p>
                    </div>
                    <div id="logs-content" style="display: none;">
                        <div class="logs-controls">
                            <button id="logs-refresh-btn" class="btn-refresh">üîÑ L√†m M·ªõi</button>
                            <button id="logs-clear-btn" class="btn-clear">üóëÔ∏è X√≥a</button>
                            <label class="auto-refresh-label">
                                <input type="checkbox" id="auto-refresh-toggle" checked>
                                Auto-refresh (1s)
                            </label>
                        </div>
                        <div class="logs-terminal">
                            <div id="logs-terminal-content" class="terminal-content"></div>
                        </div>
                        <div class="logs-footer">
                            <span id="logs-count">-</span> d√≤ng | <span id="logs-time">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="test-results">
                <h2>üìä K·∫øt Qu·∫£ Test T·ª´ Client</h2>
                <div class="test-results-container">
                    <div id="results-placeholder" class="placeholder">
                        <p>Ch∆∞a c√≥ k·∫øt qu·∫£ test. Vui l√≤ng ch·∫°y client test ƒë·ªÉ xem k·∫øt qu·∫£.</p>
                    </div>
                    <div id="results-content" style="display: none;">
                        <div class="results-summary">
                            <h3>T·ªïng Quan</h3>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="label">T·ªïng Requests:</span>
                                    <span class="value" id="total-requests">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Th√†nh C√¥ng:</span>
                                    <span class="value success" id="success-count">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Th·∫•t B·∫°i:</span>
                                    <span class="value error" id="failed-count">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">T·ª∑ L·ªá Th√†nh C√¥ng:</span>
                                    <span class="value" id="success-rate">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="results-table">
                            <h3>Chi Ti·∫øt T·ª´ng Request</h3>
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Path</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Time (ms)</th>
                                        <th>Size (bytes)</th>
                                    </tr>
                                </thead>
                                <tbody id="results-tbody">
                                </tbody>
                            </table>
                        </div>

                        <div class="results-stats">
                            <h3>Th·ªëng K√™ Th·ªùi Gian Response</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="label">Min:</span>
                                    <span class="value" id="time-min">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="label">Max:</span>
                                    <span class="value" id="time-max">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="label">Avg:</span>
                                    <span class="value" id="time-avg">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="label">Median:</span>
                                    <span class="value" id="time-median">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="results-footer">
                            <p><small id="results-timestamp">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: -</small></p>
                            <button id="refresh-btn" class="btn-refresh">üîÑ L√†m M·ªõi</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Web Server Project. Made with ‚ù§Ô∏è in Python</p>
        </div>
    </footer>

    <script>
        // Variables for auto-refresh
        let autoRefreshLogsInterval = null;
        let autoRefreshTestInterval = null;

        // ===== SERVER LOGS FUNCTIONALITY =====
        async function loadServerLogs() {
            try {
                const response = await fetch('/api/logs');
                console.log('Fetch response status:', response.status);
                
                if (!response.ok) {
                    console.error('API returned status:', response.status);
                    showLogsPlaceholder();
                    return;
                }
                
                const text = await response.text();
                console.log('Raw response length:', text.length);
                
                if (!text) {
                    console.log('Empty response');
                    showLogsPlaceholder();
                    return;
                }
                
                const data = JSON.parse(text);
                console.log('Parsed data:', data);
                
                if (data && data.logs && data.logs.length > 0) {
                    displayServerLogs(data);
                } else {
                    console.log('No logs in data');
                    showLogsPlaceholder();
                }
            } catch (error) {
                console.error('Error loading server logs:', error);
                showLogsPlaceholder();
            }
        }
        
        function showLogsPlaceholder() {
            document.getElementById('logs-placeholder').style.display = 'block';
            document.getElementById('logs-content').style.display = 'none';
            // C·∫≠p nh·∫≠t text placeholder
            const placeholder = document.getElementById('logs-placeholder');
            if (placeholder) {
                placeholder.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu logs. Trang s·∫Ω hi·ªÉn th·ªã server logs khi client g·ª≠i requests.</p>';
            }
        }
        
        function displayServerLogs(data) {
            const logs = data.logs;
            const timestamp = data.timestamp;
            
            // ·∫®n placeholder, hi·ªÉn th·ªã content
            document.getElementById('logs-placeholder').style.display = 'none';
            document.getElementById('logs-content').style.display = 'block';
            
            // Populate logs terminal
            const logsContent = document.getElementById('logs-terminal-content');
            
            logsContent.innerHTML = '';
            
            logs.forEach((log, index) => {
                const logLine = document.createElement('div');
                logLine.className = 'log-line';
                
                // Ph√¢n lo·∫°i log theo level t·ª´ format: YYYY-MM-DD HH:MM:SS - [ThreadName] - LEVEL - message
                if (log.includes('- ERROR -')) {
                    logLine.classList.add('log-error');
                } else if (log.includes('- WARNING -')) {
                    logLine.classList.add('log-warning');
                } else if (log.includes('- INFO -')) {
                    logLine.classList.add('log-info');
                } else if (log.includes('- DEBUG -')) {
                    logLine.classList.add('log-debug');
                }
                
                logLine.textContent = log;
                logsContent.appendChild(logLine);
            });
            
            // Scroll xu·ªëng d∆∞·ªõi c√πng - ƒë·∫£m b·∫£o th·ª±c hi·ªán ngay l·∫≠p t·ª©c
            const scrollContainer = logsContent.parentElement;
            if (scrollContainer) {
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }
            logsContent.scrollTop = logsContent.scrollHeight;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            document.getElementById('logs-count').textContent = logs.length;
            const date = new Date(timestamp);
            const formattedTime = date.toLocaleString('vi-VN');
            document.getElementById('logs-time').textContent = formattedTime;
        }
        
        // ===== TEST RESULTS FUNCTIONALITY =====
        async function loadTestResults() {
            try {
                const response = await fetch('/api/test-results');
                const data = await response.json();
                
                if (data && data.results && data.results.length > 0) {
                    displayResults(data);
                } else {
                    showPlaceholder();
                }
            } catch (error) {
                console.error('Error loading test results:', error);
                showPlaceholder();
            }
        }
        
        
        function showPlaceholder() {
            document.getElementById('results-placeholder').style.display = 'block';
            document.getElementById('results-content').style.display = 'none';
        }
        
        function displayResults(data) {
            const results = data.results;
            const timestamp = data.timestamp;
            
            // ·∫®n placeholder, hi·ªÉn th·ªã content
            document.getElementById('results-placeholder').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            
            // T√≠nh to√°n th·ªëng k√™
            const successResults = results.filter(r => r.success);
            const failedResults = results.filter(r => !r.success);
            const successRate = ((successResults.length / results.length) * 100).toFixed(1);
            
            // C·∫≠p nh·∫≠t summary
            document.getElementById('total-requests').textContent = results.length;
            document.getElementById('success-count').textContent = successResults.length;
            document.getElementById('failed-count').textContent = failedResults.length;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            // Populate results table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                const statusClass = result.success ? 'status-ok' : 'status-error';
                const status = result.status_code ? `${result.status_code}` : 'ERROR';
                
                row.innerHTML = `
                    <td>${result.request_id}</td>
                    <td>${result.path}</td>
                    <td>${result.method}</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${result.response_time ? result.response_time.toFixed(2) : '-'}</td>
                    <td>${result.content_length}</td>
                `;
                tbody.appendChild(row);
            });
            
            // T√≠nh to√°n th·ªëng k√™ th·ªùi gian
            if (successResults.length > 0) {
                const times = successResults.map(r => r.response_time).sort((a, b) => a - b);
                const minTime = Math.min(...times);
                const maxTime = Math.max(...times);
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const medianTime = times[Math.floor(times.length / 2)];
                
                document.getElementById('time-min').textContent = minTime.toFixed(2) + ' ms';
                document.getElementById('time-max').textContent = maxTime.toFixed(2) + ' ms';
                document.getElementById('time-avg').textContent = avgTime.toFixed(2) + ' ms';
                document.getElementById('time-median').textContent = medianTime.toFixed(2) + ' ms';
            }
            
            // C·∫≠p nh·∫≠t timestamp
            const date = new Date(timestamp);
            const formattedTime = date.toLocaleString('vi-VN');
            document.getElementById('results-timestamp').textContent = `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${formattedTime}`;
        }
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Load logs khi trang load
            loadServerLogs();
            loadTestResults();
            
            // Logs refresh button
            const logsRefreshBtn = document.getElementById('logs-refresh-btn');
            if (logsRefreshBtn) {
                logsRefreshBtn.addEventListener('click', function() {
                    loadServerLogs();
                    this.textContent = '‚è≥ ƒêang c·∫≠p nh·∫≠t...';
                    setTimeout(() => {
                        this.textContent = 'üîÑ L√†m M·ªõi';
                    }, 500);
                });
            }
            
            // Logs clear button
            const logsClearBtn = document.getElementById('logs-clear-btn');
            if (logsClearBtn) {
                logsClearBtn.addEventListener('click', function() {
                    const logsContent = document.getElementById('logs-terminal-content');
                    logsContent.innerHTML = '';
                    document.getElementById('logs-count').textContent = '0';
                });
            }
            
            // Auto-refresh toggle for logs
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('change', function() {
                    if (this.checked) {
                        startAutoRefreshLogs();
                    } else {
                        stopAutoRefreshLogs();
                    }
                });
                // Kh·ªüi ƒë·ªông auto-refresh n·∫øu checkbox checked
                if (autoRefreshToggle.checked) {
                    startAutoRefreshLogs();
                }
            }
            
            // Refresh button for test results
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    loadTestResults();
                    this.textContent = '‚è≥ ƒêang c·∫≠p nh·∫≠t...';
                    setTimeout(() => {
                        this.textContent = 'üîÑ L√†m M·ªõi';
                    }, 1000);
                });
            }
            
            // Auto-refresh test results every 30 seconds
            autoRefreshTestInterval = setInterval(loadTestResults, 30000);
        });
        
        function startAutoRefreshLogs() {
            if (autoRefreshLogsInterval) {
                clearInterval(autoRefreshLogsInterval);
            }
            autoRefreshLogsInterval = setInterval(loadServerLogs, 1000); // 1 gi√¢y thay v√¨ 5 gi√¢y
        }
        
        function stopAutoRefreshLogs() {
            if (autoRefreshLogsInterval) {
                clearInterval(autoRefreshLogsInterval);
                autoRefreshLogsInterval = null;
            }
        }
    </script>
</body>
</html>
